<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="PowerPad.WinUI.Components.SearchModelsResultRepeater"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:PowerPad.WinUI.Components"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:vmai="using:PowerPad.WinUI.ViewModels.AI"
    xmlns:controls="using:PowerPad.WinUI.Components.Controls"
    xmlns:tkui="using:CommunityToolkit.WinUI"
    xmlns:tkcontrols="using:CommunityToolkit.WinUI.Controls"
    xmlns:tkconverters="using:CommunityToolkit.WinUI.Converters"
    mc:Ignorable="d">
    <UserControl.Resources>
        <x:Double x:Key="SettingsCardWrapThreshold">300</x:Double>
        <tkconverters:FileSizeToFriendlyStringConverter x:Key="FileSizeToFriendlyStringConverter" />
        <tkconverters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <tkconverters:EmptyObjectToObjectConverter x:Key="EmptyObjectToVisibilityConverter"
                                                 EmptyValue="Collapsed"
                                                 NotEmptyValue="Visible" />
    </UserControl.Resources>
    <Grid>
        <tkcontrols:SwitchPresenter 
            x:Name="MainContent"
            HorizontalAlignment="Center"
            TargetType="x:Boolean"
            Value="{x:Bind SearchingFlag, Mode=OneWay}"
            Visibility="{x:Bind SearchEmpty, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}">
            <tkcontrols:Case Value="True">
                <StackPanel
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Orientation="Vertical"
                    Spacing="16">
                    <muxc:ProgressRing IsActive="{x:Bind SearchingFlag, Mode=OneWay}" Height="60" Width="60" />
                    <TextBlock HorizontalAlignment="Center"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        FontSize="18"
                        Text="Buscando..." />
                </StackPanel>
            </tkcontrols:Case>
            <tkcontrols:Case Value="False">
                <ScrollView x:Name="ModelsScrollViewer" VerticalAlignment="Center">
                    <Grid Padding="36,0,36,36">
                        <StackPanel MaxWidth="1000" HorizontalAlignment="Stretch">
                            <ItemsRepeater ItemsSource="{x:Bind Models, Mode=OneWay}">
                                <ItemsRepeater.Layout>
                                    <UniformGridLayout
                                        ItemsStretch="Fill"
                                        MinColumnSpacing="12"
                                        MinItemWidth="386"
                                        MinRowSpacing="12" />
                                </ItemsRepeater.Layout>
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="vmai:AIModelViewModel">
                                        <tkcontrols:SettingsCard
                                            HeaderIcon="{tkui:FontIcon Glyph=&#xF158;}" Padding="18, 0">
                                            <tkcontrols:SettingsCard.Header>
                                                <Grid ColumnSpacing="8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock
                                                        Text="{x:Bind CardName}" 
                                                        ToolTipService.ToolTip="{x:Bind CardName}"
                                                        TextTrimming="CharacterEllipsis"
                                                        TextWrapping="Wrap"
                                                        MaxLines="2"/>
                                                    <HyperlinkButton
                                                        Grid.Column="1"
                                                        ToolTipService.ToolTip="Más información"
                                                        Tag="{x:Bind}"
                                                        Visibility="{x:Bind InfoUrl, Converter={StaticResource EmptyObjectToVisibilityConverter}}"
                                                        Padding="0"
                                                        BorderThickness="0"
                                                        Click="HyperlinkButton_Click" CornerRadius="5">
                                                        <FontIcon Glyph="&#xE946;" FontSize="18" Foreground="{ThemeResource AccentFillColorDefaultBrush}" />
                                                    </HyperlinkButton>
                                                </Grid>
                                            </tkcontrols:SettingsCard.Header>
                                            <tkcontrols:SettingsCard.Description>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                        Visibility="{x:Bind Downloading, Mode=OneWay}"
                                                        Text="Descarga en curso..." />
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                        Visibility="{x:Bind Available, Mode=OneWay}"
                                                        Text="Modelo ya disponible" />
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                        Visibility="{x:Bind IsSizeTooLargeForExecution, Mode=OneWay}"
                                                        Text="Demasiado grande para este equipo" />
                                                </StackPanel>
                                            </tkcontrols:SettingsCard.Description>
                                            <StackPanel Orientation="Horizontal" Spacing="4" Height="40">
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    Margin="0,0,8,0"
                                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                    Text="{x:Bind Size, Converter={StaticResource FileSizeToFriendlyStringConverter}}" />
                                                <Button Width="35" Height="35" Padding="0"
                                                    Content="{tkui:FontIcon Glyph=&#xE710;,FontSize=14}"
                                                    Tag="{x:Bind}"
                                                    ToolTipService.ToolTip="Añadir"
                                                    Visibility="{x:Bind CanAdd, Mode=OneWay}"
                                                    Click="OnAddModelClick" 
                                                    Style="{StaticResource AccentButtonStyle}"/>
                                                <Button Width="35" Height="35" Padding="0"
                                                    Content="{tkui:FontIcon Glyph=&#xE73E;,FontSize=14}"
                                                    Visibility="{x:Bind Available, Mode=OneWay}"
                                                    IsEnabled="False"
                                                    Style="{StaticResource AccentButtonStyle}"/>
                                                <Button Width="35" Height="35" Padding="0"
                                                    Content="{tkui:FontIcon Glyph=&#xF140;,FontSize=14}"
                                                    Visibility="{x:Bind IsSizeTooLargeForExecution, Mode=OneWay}"
                                                    IsEnabled="False"
                                                    Style="{StaticResource AccentButtonStyle}"/>
                                                <muxc:ProgressRing Width="35" Height="35"
                                                    Background="Gray"
                                                    Visibility="{x:Bind Downloading, Mode=OneWay}"
                                                    Value="{x:Bind Progress, Mode=OneWay}"
                                                    IsIndeterminate="False" />
                                            </StackPanel>
                                        </tkcontrols:SettingsCard>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>
                    </Grid>
                </ScrollView>
            </tkcontrols:Case>
        </tkcontrols:SwitchPresenter>
        <StackPanel 
            Visibility="{x:Bind SearchEmpty, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
            Orientation="Vertical" 
            HorizontalAlignment="Stretch" 
            VerticalAlignment="Center"
            Spacing="8">
            <TextBlock HorizontalAlignment="Center" FontWeight="SemiBold"
                Text="No se han encontrado modelos" />
            <TextBlock HorizontalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                Text="Pruebe con otro término de búsqueda." />
            <FontIcon 
                Margin="0,28,0,0" FontSize="120" Opacity="0.2"  
                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                Glyph="&#xEA39;" />
        </StackPanel>
        <controls:ModelInfoViewer x:Name="ModelInfoViewer" VisibilityChanged="ModelInfoViewer_VisibilityChanged"/>
    </Grid>
</UserControl>
