<?xml version="1.0" encoding="utf-8"?>
<local:DisposablePage
    x:Class="PowerPad.WinUI.Pages.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:PowerPad.WinUI.Pages"
    xmlns:components="using:PowerPad.WinUI.Components"
    xmlns:localc="using:PowerPad.WinUI.Components.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:mux="using:Microsoft.UI.Xaml"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:PowerPad.WinUI.Converters"
    xmlns:toolkitconverters="using:CommunityToolkit.WinUI.Converters"
    xmlns:ai="using:PowerPad.Core.Models.AI"
    mc:Ignorable="d">
    <local:DisposablePage.Resources>
        <converters:ServiceStatusToColorBrushConverter x:Key="ServiceStatusToColorBrushConverter" />
        <converters:ServiceStatusToStringConverter x:Key="ServiceStatusToStringConverter" />
        <converters:ServiceStatusToBoolNegationConverter x:Key="ServiceStatusToBoolNegationConverter" />
        <converters:ServiceStatusToVisibilityConverter x:Key="ServiceStatusToVisibilityConverter" />
        <converters:ServiceStatusToVisibilityNegationConverter x:Key="ServiceStatusToVisibilityNegationConverter" />
        <converters:AIModelToSourceConverter x:Key="AIModelToSourceConverter" />
        <converters:IntToDoubleConverter x:Key="IntToDoubleConverter"/>
        <converters:FloatToDoubleConverter x:Key="FloatToDoubleConverter"/>
        <toolkitconverters:StringFormatConverter x:Key="StringFormatConverter" />
        <toolkitconverters:StringVisibilityConverter x:Key="StringVisibilityConverter" />
        <Style x:Key="SettingsSectionHeaderTextBlockStyle" BasedOn="{StaticResource BodyStrongTextBlockStyle}" TargetType="TextBlock">
            <Setter Property="Margin" Value="1,30,0,6" />
        </Style>
        <Style x:Key="FullRowSettingCard" TargetType="Border">
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="58,8,44,8" />
            <Setter Property="BorderThickness" Value="0,1,0,0" />
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}" />
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}" />
        </Style>
        <Style x:Key="InfoBarServiceStyle" TargetType="InfoBar">
            <Setter Property="CornerRadius" Value="0" />
            <Setter Property="Margin" Value="-1,1,-1,-1" />
        </Style>
        <Style x:Key="InfoBarSettingCard" TargetType="Border">
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="58,10,44,10" />
            <Setter Property="BorderThickness" Value="0,1,0,0" />
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}" />
            <Setter Property="Background" Value="{ThemeResource InfoBarErrorSeverityBackgroundBrush}" />
        </Style>
    </local:DisposablePage.Resources>
    <Grid Margin="0,0,0,2">
        <Grid.RowDefinitions>
            <RowDefinition Height="48" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Border
            Grid.Row="1"
            Background="{ThemeResource PowerPadEditorBrush}"
            CornerRadius="10,0,0,0">
            <ScrollViewer 
                x:Name="ModelsScrollViewer">
                <Grid Padding="36,24,36,36">
                    <StackPanel
                        MaxWidth="1000"
                        HorizontalAlignment="Stretch">
                        <TextBlock
                            Style="{StaticResource TitleTextBlockStyle}"
                            Text="Ajustes"/>
                        
                        <!-- Local Services Section -->
                        <StackPanel Orientation="Horizontal">
                            <FontIcon Glyph="&#xE977;" Margin="0,16,8,0"/>
                            <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" Text="Servicios locales" />
                        </StackPanel>
                        <!-- Ollama -->
                        <toolkit:SettingsExpander
                            x:Name="OllamaModelsExpander"
                            Description="IA generativa en tu equipo local o red privada con Ollama">
                            <toolkit:SettingsExpander.HeaderIcon>
                                <ImageIcon Source="{ThemeResource OllamaSvg}"/>
                            </toolkit:SettingsExpander.HeaderIcon>
                            <toolkit:SettingsExpander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <FontIcon FontSize="14" Foreground="{ThemeResource AccentFillColorDefaultBrush}" Margin="-38,0,0,0" Glyph="&#xF167;"
                                        Visibility="{x:Bind _settings.General.OllamaConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}"/>
                                    <TextBlock Text="Ollama" />
                                </StackPanel>
                            </toolkit:SettingsExpander.Header>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <ToggleSwitch 
                                    IsOn="{x:Bind _settings.General.OllamaEnabled, Mode=TwoWay}" 
                                    Toggled="OllamaModelsExpander_Toggled" />
                            </StackPanel>
                            <toolkit:SettingsExpander.ItemsHeader>
                                <Border 
                                    Style="{StaticResource InfoBarSettingCard}"
                                    Visibility="{x:Bind _settings.General.OllamaConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}">
                                    <Grid Margin="-58,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="58" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="auto" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon Glyph="&#xEB90;" Foreground="{ThemeResource InfoBarErrorSeverityIconBackground}" />
                                        <TextBlock 
                                            Grid.Column="1" 
                                            Text="{x:Bind _settings.General.OllamaConfig.ErrorMessage, Mode=OneWay}" 
                                            VerticalAlignment="Center"
                                            IsTextSelectionEnabled="True"
                                            TextWrapping="Wrap" />
                                        <Button Margin="16,0,0,0" Grid.Column="2" x:Name="OllamaRetryButton" Click="RetryButton_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <FontIcon Glyph="&#xE777;" FontSize="14" Margin="0,0,8,0" />
                                                <TextBlock>Reintentar</TextBlock>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>
                            </toolkit:SettingsExpander.ItemsHeader>
                            <toolkit:SettingsExpander.Items>
                                <toolkit:SettingsCard>
                                    <toolkit:SettingsCard.Header>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="150" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <localc:Label 
                                                IsEnabled="{x:Bind _settings.General.OllamaEnabled, Mode=OneWay}"
                                                Text="Estado:" />
                                            <TextBlock 
                                                Grid.Column="1"
                                                Foreground="{x:Bind _settings.General.OllamaConfig.ServiceStatus, Mode=OneWay, Converter={StaticResource ServiceStatusToColorBrushConverter}}"
                                                Text="{x:Bind _settings.General.OllamaConfig.ServiceStatus, Mode=OneWay, Converter={StaticResource ServiceStatusToStringConverter}, ConverterParameter=True}"/>
                                        </Grid>
                                    </toolkit:SettingsCard.Header>
                                    <toolkit:SwitchPresenter Value="{x:Bind _settings.General.OllamaConfig.ServiceStatus, Mode=OneWay}">
                                        <toolkit:Case Value="{x:Bind ai:ServiceStatus.Online}">
                                            <Button 
                                                x:Name="StopOllama"
                                                ToolTipService.ToolTip="Parar" 
                                                Click="StopOllama_Click">
                                                <StackPanel Orientation="Horizontal">
                                                    <FontIcon Glyph="&#xE71A;" FontSize="14" Margin="0,0,10,0" />
                                                    <TextBlock>Parar</TextBlock>
                                                </StackPanel>
                                            </Button>
                                        </toolkit:Case>
                                        <toolkit:Case Value="{x:Bind ai:ServiceStatus.Available}">
                                            <Button 
                                                x:Name="StartOllama"
                                                ToolTipService.ToolTip="Iniciar" 
                                                Click="StartOllama_Click">
                                                <StackPanel Orientation="Horizontal">
                                                    <FontIcon Glyph="&#xE768;" FontSize="14" Margin="0,0,10,0" />
                                                    <TextBlock>Iniciar</TextBlock>
                                                </StackPanel>
                                            </Button>
                                        </toolkit:Case>
                                        <toolkit:Case Value="{x:Bind ai:ServiceStatus.NotFound}">
                                            <Button 
                                                x:Name="InstallOllama"
                                                ToolTipService.ToolTip="Instalar" 
                                                Click="InstallOllama_Click">
                                                <StackPanel Orientation="Horizontal">
                                                    <FontIcon Glyph="&#xE896;" FontSize="14" Margin="0,0,10,0" />
                                                    <TextBlock>Instalar</TextBlock>
                                                </StackPanel>
                                            </Button>
                                        </toolkit:Case>
                                    </toolkit:SwitchPresenter>
                                </toolkit:SettingsCard>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label
                                            IsEnabled="{x:Bind _settings.General.OllamaEnabled, Mode=OneWay}"
                                            Text="URL:" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            x:Name="OllamaUrlTextBox"
                                            Value="{x:Bind _settings.General.OllamaConfig.BaseUrl, Mode=TwoWay}"
                                            IsEnabled="{x:Bind _settings.General.OllamaEnabled, Mode=OneWay}" />
                                    </Grid>
                                </Border>
                                <toolkit:SettingsCard  ContentAlignment="Left">
                                    <CheckBox 
                                        IsChecked="{x:Bind _settings.General.OllamaAutostart, Mode=TwoWay}"
                                        IsEnabled="{x:Bind _settings.General.OllamaEnabled, Mode=OneWay}">
                                        <TextBlock Margin="8,2,0,0">Iniciar Ollama automáticamente al abrir</TextBlock>
                                    </CheckBox>
                                </toolkit:SettingsCard>
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>

                        <!-- Cloud Services Section -->
                        <StackPanel Orientation="Horizontal">
                            <FontIcon Glyph="&#xE753;" Margin="0,22,8,0"/>
                            <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" Text="Servicios en línea" />
                        </StackPanel>
                        <!-- AzureAI -->
                        <toolkit:SettingsExpander
                            x:Name="AzureAIModelsExpander"
                            Description="Utiliza los modelos de GitHub con el API de Azure AI">
                            <toolkit:SettingsExpander.HeaderIcon>
                                <ImageIcon Source="{ThemeResource AzureAISvg}"/>
                            </toolkit:SettingsExpander.HeaderIcon>
                            <toolkit:SettingsExpander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <FontIcon FontSize="14" Foreground="{ThemeResource AccentFillColorDefaultBrush}" Margin="-38,0,0,0" Glyph="&#xF167;"
                                        Visibility="{x:Bind _settings.General.AzureAIConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}"/>
                                    <TextBlock Text="Azure AI" />
                                </StackPanel>
                            </toolkit:SettingsExpander.Header>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <ToggleSwitch IsOn="{x:Bind _settings.General.AzureAIEnabled, Mode=TwoWay}" Toggled="AzureAIModelsExpander_Toggled" />
                            </StackPanel>
                            <toolkit:SettingsExpander.ItemsHeader>
                                <Border 
                                    Style="{StaticResource InfoBarSettingCard}"
                                    Visibility="{x:Bind _settings.General.AzureAIConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}">
                                    <Grid Margin="-58,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="58" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="auto" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon Glyph="&#xEB90;" Foreground="{ThemeResource InfoBarErrorSeverityIconBackground}" />
                                        <TextBlock 
                                            Grid.Column="1" 
                                            Text="{x:Bind _settings.General.AzureAIConfig.ErrorMessage, Mode=OneWay}" 
                                            VerticalAlignment="Center"
                                            IsTextSelectionEnabled="True"
                                            TextWrapping="Wrap" />
                                        <Button Margin="16,0,0,0" Grid.Column="2" x:Name="AzureAIRetryButton" Click="RetryButton_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <FontIcon Glyph="&#xE777;" FontSize="14" Margin="0,0,8,0" />
                                                <TextBlock>Reintentar</TextBlock>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>
                            </toolkit:SettingsExpander.ItemsHeader>
                            <toolkit:SettingsExpander.Items>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label
                                            IsEnabled="{x:Bind _settings.General.AzureAIEnabled, Mode=OneWay}"
                                            Text="URL:" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            x:Name="AzureAIUrlTextBox"
                                            Value="{x:Bind _settings.General.AzureAIConfig.BaseUrl, Mode=TwoWay}"
                                            IsEnabled="{x:Bind _settings.General.AzureAIEnabled, Mode=OneWay}"/>
                                    </Grid>
                                </Border>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label
                                            IsEnabled="{x:Bind _settings.General.AzureAIEnabled, Mode=OneWay}"
                                            Text="Clave:" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            x:Name="AzureAIKeyTextBox"
                                            Value="{x:Bind _settings.General.AzureAIConfig.Key, Mode=TwoWay}"
                                            IsEnabled="{x:Bind _settings.General.AzureAIEnabled, Mode=OneWay}"
                                            PasswordMode="True" />
                                    </Grid>
                                </Border>
                                <toolkit:SettingsCard ContentAlignment="Left">
                                    <StackPanel Margin="-12,0,0,0"
                                        Orientation="Vertical">
                                        <HyperlinkButton Content="Pruebe modelos gratuitos de GitHub Models con un token de desarrollador" NavigateUri="https://github.com/settings/tokens" />
                                        <HyperlinkButton Content="Consiga una clave de Azure AI de pago por uso" NavigateUri="https://ai.azure.com/github" />
                                    </StackPanel>
                                </toolkit:SettingsCard><!-- Links -->
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>
                        <!-- OpenAI -->
                        <toolkit:SettingsExpander
                            x:Name="OpenAIModelsExpander"
                            Description="Utiliza modelos de ChatGPT a través de su API">
                            <toolkit:SettingsExpander.HeaderIcon>
                                <ImageIcon Source="{ThemeResource OpenAISvg}"/>
                            </toolkit:SettingsExpander.HeaderIcon>
                            <toolkit:SettingsExpander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <FontIcon x:Name="ErrorBadge" FontSize="14" Foreground="{ThemeResource AccentFillColorDefaultBrush}" Margin="-38,0,0,0" Glyph="&#xF167;"
                                        Visibility="{x:Bind _settings.General.OpenAIConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}"/>
                                    <TextBlock Text="OpenAI" />
                                </StackPanel>
                            </toolkit:SettingsExpander.Header>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <ToggleSwitch IsOn="{x:Bind _settings.General.OpenAIEnabled, Mode=TwoWay}" Toggled="OpenAIModelsExpander_Toggled" />
                            </StackPanel>
                            <toolkit:SettingsExpander.ItemsHeader>
                                <Border 
                                    Style="{StaticResource InfoBarSettingCard}"
                                    Visibility="{x:Bind _settings.General.OpenAIConfig.ErrorMessage, Mode=OneWay, Converter={StaticResource StringVisibilityConverter}}">
                                    <Grid Margin="-58,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="58" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="auto" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon Glyph="&#xEB90;" Foreground="{ThemeResource InfoBarErrorSeverityIconBackground}" />
                                        <TextBlock
                                            Grid.Column="1"
                                            Text="{x:Bind _settings.General.OpenAIConfig.ErrorMessage, Mode=OneWay}"
                                            VerticalAlignment="Center"
                                            IsTextSelectionEnabled="True"
                                            TextWrapping="Wrap" />
                                        <Button Margin="16,0,0,0" Grid.Column="2" x:Name="OpenAIRetryButton" Click="RetryButton_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <FontIcon Glyph="&#xE777;" FontSize="14" Margin="0,0,8,0" />
                                                <TextBlock>Reintentar</TextBlock>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>
                            </toolkit:SettingsExpander.ItemsHeader>
                            <toolkit:SettingsExpander.Items>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label 
                                            VerticalAlignment="Center"
                                            Text="URL:"
                                            IsEnabled="{x:Bind _settings.General.OpenAIEnabled, Mode=OneWay}" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            x:Name="OpenAIUrlTextBox"
                                            Value="{x:Bind _settings.General.OpenAIConfig.BaseUrl, Mode=TwoWay}"
                                            IsEnabled="{x:Bind _settings.General.OpenAIEnabled, Mode=OneWay}"/>
                                    </Grid>
                                </Border>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label 
                                            VerticalAlignment="Center"
                                            Text="Clave:"
                                            IsEnabled="{x:Bind _settings.General.OpenAIEnabled, Mode=OneWay}" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            x:Name="OpenAIKeyTextBox"
                                            Value="{x:Bind _settings.General.OpenAIConfig.Key, Mode=TwoWay}"
                                            IsEnabled="{x:Bind _settings.General.OpenAIEnabled, Mode=OneWay}"
                                            PasswordMode="True" />
                                    </Grid>
                                </Border>
                                <toolkit:SettingsCard ContentAlignment="Left">
                                    <StackPanel Margin="-12,0,0,0"
                                        Orientation="Vertical">
                                        <HyperlinkButton Content="Consiga una clave de de OpenAI de pago por uso" NavigateUri="https://platform.openai.com/signup" />
                                    </StackPanel>
                                </toolkit:SettingsCard>
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>

                        <!-- Default Config -->
                        <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                            Text="Configuración por defecto" />
                        <toolkit:SettingsCard
                            x:Name="DefaultModelCard"
                            Description="Modelo predeterminado nuevos chats y agentes"
                            Header="Modelo"
                            HeaderIcon="{ui:FontIcon Glyph=&#xF158;}">
                            <StackPanel>
                                <Button x:Name="FakeButton" Visibility="Collapsed">Unavailable</Button>
                                <DropDownButton x:Name="DefaultModelButton" Click="DefaultModelButton_Click" Height="32">
                                    <DropDownButton.Flyout>
                                        <MenuFlyout
                                            x:Name="DefaultModelFlyoutMenu" 
                                            Placement="TopEdgeAlignedLeft">
                                        </MenuFlyout>
                                    </DropDownButton.Flyout>
                                    <DropDownButton.Content>
                                        <StackPanel Orientation="Horizontal">
                                            <localc:ButtonIcon 
                                                x:Name="ModelIcon"
                                                Source="{x:Bind _settings.Models.DefaultModel, Mode=OneWay, Converter={StaticResource AIModelToSourceConverter}}"/>
                                            <TextBlock 
                                                x:Name="ModelName" 
                                                MaxWidth="150" 
                                                TextTrimming="CharacterEllipsis" 
                                                Margin="8,0,0,0"
                                                Text="{x:Bind _settings.Models.DefaultModel.CardName, Mode=OneWay}"/>
                                        </StackPanel>
                                    </DropDownButton.Content>
                                </DropDownButton>
                            </StackPanel>
                        </toolkit:SettingsCard>
                        <toolkit:SettingsExpander
                            x:Name="DefaultParameterCard"
                            Header="Parámetros"
                            Description="Enviar parámetros adicionales de forma predeterminada"
                            HeaderIcon="{ui:FontIcon FontFamily='Segoe MDL2 Assets', Glyph=&#xE9E9;}">
                            <toolkit:SettingsExpander.Resources>
                                <SolidColorBrush x:Key="SettingsCardBorderBrushDisabled" Color="Transparent" />
                            </toolkit:SettingsExpander.Resources>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <ToggleSwitch IsOn="{x:Bind _settings.Models.SendDefaultParameters, Mode=TwoWay}" />
                            </StackPanel>
                            <toolkit:SettingsExpander.Items>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <StackPanel Spacing="0" Margin="0,8,0,0">
                                        <localc:Label
                                            IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}"
                                            Text="Instrucciones de sistema:" />
                                        <localc:EditableTextBlock
                                            Value="{x:Bind _settings.Models.DefaultParameters.SystemPrompt, Mode=TwoWay}"
                                            PlaceholderText="Escriba aquí las indicaciones para el modelo"
                                            IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}"/>
                                    </StackPanel>
                                </Border>
                                <toolkit:SettingsCard IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}">
                                    <toolkit:SettingsCard.Header>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Margin="0,0,8,0">Temperatura</TextBlock>
                                            <localc:Label 
                                                Text="(nivel de aleatoriedad)" 
                                                Foreground="{ThemeResource TextFillColorTertiaryBrush}" 
                                                VerticalAlignment="Center" />
                                        </StackPanel>
                                    </toolkit:SettingsCard.Header>
                                    <StackPanel Orientation="Horizontal">
                                        <Slider
                                            Width="250"
                                            Minimum="0" 
                                            Maximum="1" 
                                            StepFrequency="0.01" 
                                            IsThumbToolTipEnabled="False"
                                            Value="{x:Bind _settings.Models.DefaultParameters.Temperature, Mode=TwoWay, Converter={StaticResource FloatToDoubleConverter}}" />
                                        <localc:Label 
                                            Margin="16,0,0,0" 
                                            VerticalAlignment="Center" 
                                            Width="28"
                                            Text="{x:Bind _settings.Models.DefaultParameters.Temperature, Mode=OneWay, Converter={StaticResource StringFormatConverter}, ConverterParameter='{}{0:0.00}'}" />
                                    </StackPanel>
                                </toolkit:SettingsCard>
                                <toolkit:SettingsCard IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}">
                                    <toolkit:SettingsCard.Header>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Margin="0,0,8,0">Top P</TextBlock>
                                            <localc:Label 
                                                Text="(núcleo de palabras candidatas)" 
                                                Foreground="{ThemeResource TextFillColorTertiaryBrush}" 
                                                VerticalAlignment="Center" />
                                        </StackPanel>
                                    </toolkit:SettingsCard.Header>
                                    <StackPanel Orientation="Horizontal">
                                        <Slider
                                            Width="250"
                                            Minimum="0" 
                                            Maximum="1" 
                                            StepFrequency="0.01" 
                                            IsThumbToolTipEnabled="False"
                                            Value="{x:Bind _settings.Models.DefaultParameters.TopP, Mode=TwoWay, Converter={StaticResource FloatToDoubleConverter}}" />
                                        <localc:Label 
                                            Margin="16,0,0,0" 
                                            VerticalAlignment="Center" 
                                            Width="28"
                                            Text="{x:Bind _settings.Models.DefaultParameters.TopP, Mode=OneWay, Converter={StaticResource StringFormatConverter}, ConverterParameter='{}{0:0.00}'}" />
                                    </StackPanel>
                                </toolkit:SettingsCard>
                                <toolkit:SettingsCard IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}">
                                    <toolkit:SettingsCard.Header>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Margin="0,0,8,0">Número máximo de tokens generados</TextBlock>
                                        </StackPanel>
                                    </toolkit:SettingsCard.Header>
                                    <NumberBox 
                                        SpinButtonPlacementMode="Inline"
                                        Width="296"
                                        SmallChange="10"
                                        LargeChange="100"
                                        Minimum="10"
                                        Value="{x:Bind _settings.Models.DefaultParameters.MaxOutputTokens, Mode=TwoWay, Converter={StaticResource IntToDoubleConverter}}"/>
                                </toolkit:SettingsCard>
                                <toolkit:SettingsCard IsEnabled="{x:Bind _settings.Models.SendDefaultParameters, Mode=OneWay}">
                                    <toolkit:SettingsCard.Header>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Margin="0,0,8,0">Tamaño máximo de la conversación</TextBlock>
                                        </StackPanel>
                                    </toolkit:SettingsCard.Header>
                                    <NumberBox 
                                        SpinButtonPlacementMode="Inline"
                                        Width="296"
                                        SmallChange="10"
                                        LargeChange="100"
                                        Minimum="1"
                                        Value="{x:Bind _settings.Models.DefaultParameters.MaxConversationLength, Mode=TwoWay, Converter={StaticResource IntToDoubleConverter}}"/>
                                </toolkit:SettingsCard>
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>
                        <toolkit:SettingsExpander
                            x:Name="AgentConfigCard"
                            Header="Agentes"
                            Description="Configuración específica para los agentes"
                            HeaderIcon="{ui:FontIcon Glyph=&#xE99A;}">
                            <toolkit:SettingsExpander.Resources>
                                <SolidColorBrush x:Key="SettingsCardBorderBrushDisabled" Color="Transparent" />
                            </toolkit:SettingsExpander.Resources>
                            <toolkit:SettingsExpander.Items>
                                <Border Style="{StaticResource FullRowSettingCard}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <localc:Label
                                            Text="Prompt adicional:" />
                                        <localc:EditableTextBlock
                                            Grid.Column="1"
                                            Value="{x:Bind _settings.General.AgentPrompt, Mode=TwoWay}" />
                                    </Grid>
                                </Border>
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>
                        
                        <!-- Visual Settings -->
                        <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                           Text="Aparencia" />
                        <toolkit:SettingsExpander Description="Seleccionar el tema que se mostrará en la aplicación"
                                           Header="Tema de la aplicación"
                                           HeaderIcon="{ui:FontIcon Glyph=&#xE790;}">
                            <toolkit:SettingsExpander.ItemsHeader>
                                <Border 
                                    x:Name="ThemeInfoBar"
                                    Style="{StaticResource InfoBarSettingCard}"
                                    Background="{ThemeResource InfoBarInformationalSeverityBackgroundBrush}"
                                    Visibility="Collapsed">
                                    <Grid Margin="-58,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="58" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="auto" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon Glyph="&#xF167;" Foreground="{ThemeResource InfoBarInformationalSeverityIconBackground}" />
                                        <TextBlock Grid.Column="1" Text="Es necesario reiniciar la aplicación para aplicar los cambios." VerticalAlignment="Center" />
                                        <Button Margin="16,0,0,0" Grid.Column="2" x:Name="ThemeInfoBarButton" Click="ThemeInfoBarButton_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <FontIcon Glyph="&#xE777;" FontSize="14" Margin="0,0,8,0" />
                                                <TextBlock>Reiniciar ahora</TextBlock>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>
                            </toolkit:SettingsExpander.ItemsHeader>
                            <toolkit:SettingsExpander.Items>
                                <toolkit:SettingsCard ContentAlignment="Left">
                                    <StackPanel Orientation="Vertical">
                                        <RadioButton
                                            x:Name="LightThemeRadioButton"
                                            Content="Claro"
                                            Tag="{x:Bind mux:ApplicationTheme.Light}" />
                                        <RadioButton
                                            x:Name="DarkThemeRadioButton"
                                            Content="Oscuro"
                                            Tag="{x:Bind mux:ApplicationTheme.Dark}" />
                                        <RadioButton
                                            x:Name="SystemThemeRadioButton"
                                            Content="Configuración del sistema" />
                                    </StackPanel>
                                </toolkit:SettingsCard>
                                <toolkit:SettingsCard ContentAlignment="Left">
                                    <StackPanel Orientation="Vertical">
                                        <CheckBox
                                            IsChecked="{x:Bind _settings.General.AcrylicBackground, Mode=TwoWay}">
                                            <TextBlock Margin="8,2,0,0">Fondo con efecto transparente</TextBlock>
                                        </CheckBox>
                                    </StackPanel>
                                </toolkit:SettingsCard>
                            </toolkit:SettingsExpander.Items>
                        </toolkit:SettingsExpander>

                        <!-- About Section -->
                        <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                           Text="Acerca de PowerPad" />
                        <toolkit:SettingsCard Description="2025 · Trabajo Fin de Grado · Ingenieria de Software · ETSISI UPM"
                            Header="PowerPad"
                            HeaderIcon="{ui:BitmapIcon Source=ms-appx:///Assets/StoreLogo.scale-200.png}">
                            <TextBlock
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               Text="Versión 1.0.0" />
                        </toolkit:SettingsCard>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Border>
    </Grid>
</local:DisposablePage>