En el contexto de la **arquitectura MVVM**, los **ViewModels** constituyen una pieza central al actuar como puente entre la interfaz de usuario y la lógica de negocio. Su función principal es gestionar el estado, la lógica y los comandos necesarios para que la vista interactúe de forma desacoplada con los modelos de datos y los servicios subyacentes. En PowerPad, los ViewModels permiten mantener una interfaz reactiva y coherente, facilitando la actualización automática de la UI y simplificando la gestión de eventos y acciones del usuario. En este apartado se revisan los ViewModels implementados en la aplicación, describiendo su papel y cómo contribuyen a la estructura y funcionamiento general del software.

## 10.1. Servicios de IA

### 10.1.1 Conversaciones

#### ChatViewModel
**Descripción general:**
`ChatViewModel` es un ViewModel encargado de gestionar la funcionalidad de chat, incluyendo la colección de mensajes, los parámetros de IA, el modelo de IA asociado y los comandos para manipular los mensajes. Supervisa los cambios en los mensajes y actualiza el estado de error del chat según corresponda.

**Código simplificado:**
```csharp
public class ChatViewModel : ObservableObject
{
    public AIModelViewModel? Model { get; set; }
    public AIParametersViewModel? Parameters { get; set; }
    public Guid? AgentId { get; set; }
    public bool ChatError { get; set; }
    public required ObservableCollection<MessageViewModel> Messages { get; set; }
    public IRelayCommand RemoveLastMessageCommand { get; }
    public IRelayCommand ClearMessagesCommand { get; }

    public ChatViewModel() { ... }

    private void RemoveLastMessage() { ...  }
    private void ClearMessages() { ...  }
    private void MessageCollectionChangedHandler( ... ) { ...  }
}
```

**Propiedades observables:**
- `Model`: Modelo de IA asociado al chat.
- `Parameters`: Parámetros de IA utilizados para configurar el comportamiento del chat.
- `AgentId`: Identificador único del agente asociado al chat.
- `ChatError`: Indica si existe un error en el chat.
- `Messages`: Colección observable de mensajes en el chat. Se inicializa con un manejador para supervisar cambios.

**Eventos:**
- Al heredar de `ObservableObject`, notifica cambios en todas las propiedades observables.

**Comandos:**
- `RemoveLastMessageCommand`: Comando para eliminar el último mensaje del chat.
- `ClearMessagesCommand`: Comando para limpiar todos los mensajes del chat.

**Otros métodos relevantes:**
- `MessageCollectionChangedHandler(object? _, NotifyCollectionChangedEventArgs eventArgs)`: Maneja los cambios en la colección de mensajes y actualiza la propiedad `ChatError` según el tipo de cambio realizado.

**Nota importante:**
- La colección `Messages` se inicializa con un manejador de eventos para detectar cambios y actualizar el estado de error del chat automáticamente.

#### MessageViewModel
**Descripción general:**
La clase `MessageViewModel` representa un mensaje dentro del chat, incluyendo su contenido, fecha y hora de creación, el rol del remitente, razonamientos opcionales, mensajes de error y estados de carga. Es utilizada para modelar cada mensaje en la interfaz de usuario de un chat, permitiendo el enlace de propiedades y la notificación de cambios.

**Código simplificado:**
```csharp
public class MessageViewModel : ObservableObject
{
    public string? Content { get; set; }
    public DateTime DateTime { get; private init; }
    public ChatRole Role { get; private init; }
    public string? Reasoning { get; set; }
    public bool Loading { get; set; }
    public string LoadingMessage { get; set; }
    public string? ErrorMessage { get; set; }
}
```

**Propiedades observables:**
- `Content`: Contenido del mensaje.
- `Reasoning`: Razonamiento o explicación asociada al mensaje.
- `Loading`: Indica si el mensaje está en estado de carga.
- `LoadingMessage`: Mensaje mostrado durante el estado de carga.
- `ErrorMessage`: Mensaje de error si el mensaje tuvo algún problema.

**Otras propiedades:**
- `DateTime`: Fecha y hora de creación del mensaje (solo lectura).
- `Role`: Rol del remitente del mensaje (solo lectura).

**Eventos:**
- Al heredar de `ObservableObject`, notifica cambios en todas las propiedades observables.

**Notas adicionales:**
- Las propiedades `Loading` y `LoadingMessage` están decoradas con `[JsonIgnore]`, por lo que no se serializan ni deserializan en operaciones JSON.
 

### 10.1.2 Gestión de modelos

#### AIModelViewModel
**Descripción general:**
ViewModel que representa y gestiona el estado de un modelo de inteligencia artificial (AIModel) en la aplicación. Permite controlar su disponibilidad, habilitación, descarga, progreso y errores asociados, además de exponer información relevante del modelo para la interfaz de usuario.

**Código simplificado:**
```csharp
public class AIModelViewModel : ObservableObject
{
    private readonly AIModel _aiModel;

    public string Name => _aiModel.Name;
    public ModelProvider ModelProvider => _aiModel.ModelProvider;
    public string? InfoUrl => _aiModel.InfoUrl;
    public bool Enabled { get; set; } = enabled;
    public bool Available { get; set; } = available;
    public bool Downloading { get; set; } = downloading;
    public double Progress { get; set; }
    public bool DownloadError { get; set; }
    public CancellationTokenSource? DownloadCancelationToken { get; set; }
    public bool IsSizeTooLargeForExecution { get; set; }
    public long? Size => _aiModel.Size;
    public string? DisplayName => _aiModel.DisplayName;
    public bool CanAdd => !Available && !Downloading && !IsSizeTooLargeForExecution;
    
    public AIModel GetRecord() => _aiModel;
    public string CardName => DisplayName ?? Name;
    public override bool Equals(object? obj) { ... }
    public override int GetHashCode() { ... }
    public static bool operator ==( ... ) { ... }
    public static bool operator !=( ... ) { ... }
    
    public void OnAvailableChanged(bool value) { ... }
    public void OnDownloadingChanged(bool value) { ... }
    public void UpdateDownloadProgress(double progress) { ... }
    public void SetDownloadError() { ... }
}
```

**Propiedades observables:**
- `Enabled`: Indica si el modelo de IA está habilitado.
- `Available`: Indica si el modelo de IA está disponible para su uso.
- `Downloading`: Indica si el modelo de IA se está descargando actualmente.
- `Progress`: Progreso de la descarga del modelo de IA.
- `DownloadError`: Indica si ha habido un error durante la descarga.

**Otras propiedades:**
- `_aiModel`: Modelo `AIModel` subyacente.
- `Name`: Nombre único del modelo de IA.
- `ModelProvider`: Proveedor del modelo de IA (por ejemplo, Ollama, OpenAI).
- `InfoUrl`: URL opcional con más información sobre el modelo.
- `DownloadCancelationToken`: Token de cancelación para la operación de descarga.
- `IsSizeTooLargeForExecution`: Indica si el tamaño del modelo es demasiado grande para su ejecución local en el equipo.
- `Size`: Tamaño opcional del modelo en bytes.
- `DisplayName`: Nombre para mostrar opcional del modelo.
- `CanAdd`: Indica si el modelo puede ser añadido (no disponible, no descargando y tamaño permitido).
- `CardName`: Devuelve el nombre para mostrar o, en su defecto, el nombre único.

**Eventos:**
- Al heredar de `ObservableObject`, notifica cambios en todas las propiedades observables y en algunas propiedades públicas modificadas explícitamente.

**Métodos públicos:**
- `AIModel GetRecord()`: Recupera el registro subyacente del modelo de IA.
- `override bool Equals(object? obj)`: Determina si el objeto especificado es igual al actual.
- `override int GetHashCode()`: Devuelve el código hash para el objeto actual.
- `static bool operator ==(AIModelViewModel? left, AIModelViewModel? right)`: Determina si dos instancias son iguales (sobrecarga del operador de igualdad).
- `static bool operator !=(AIModelViewModel? left, AIModelViewModel? right)`: Determina si dos instancias no son iguales (sobrecarga del operador de desigualdad).
- `void UpdateDownloadProgress(double progress)`: Actualiza el progreso de descarga del modelo de IA.
- `void SetDownloadError()`: Establece el estado de error de descarga a verdadero.

**Otros métodos relevantes:**
- `partial void OnAvailableChanged(bool value)`: Notifica el cambio de la propiedad `Available` y actualiza `CanAdd`.
- `partial void OnDownloadingChanged(bool value)`: Notifica el cambio de la propiedad `Downloading` y actualiza `CanAdd`.

**Notas adicionales:**
- Algunas propiedades están marcadas con `[JsonIgnore]` para evitar su persistencia.
- La clase implementa operadores de igualdad y desigualdad para facilitar la comparación entre instancias teniendo en cuenta los valores del modelo subyacente.
- Posee un constructor específico para deserialización decorado con `[JsonConstructor]`.

#### AIParameterViewModel
**Descripción general:**
Clase ViewModel para gestionar los parámetros de IA, proporcionando enlace de datos (data binding) y notificación de cambios. Permite encapsular y modificar los parámetros de IA de manera reactiva, facilitando la interacción con la interfaz de usuario.

**Código simplificado:**
```csharp
public class AIParametersViewModel : ObservableObject
{
    private readonly AIParameters _aiParameters;

    public string? SystemPrompt { get; set; }
    public float? Temperature { get; set; }
    public float? TopP { get; set; }
    public int? MaxOutputTokens { get; set; }
    public int? MaxConversationLength { get; set; }

    public AIParameters GetRecord() { get; }
    public void SetRecord(AIParameters parameters) { ... }
    public override bool Equals(object? obj) { ... }
    public override int GetHashCode() { ... }
    public static bool operator ==( ... ) { ... }
    public static bool operator !=( ... ) { ... }
    public AIParametersViewModel Copy() { ... }
}
```

**Propiedades observables:**
- No hay propiedades marcadas explícitamente con `[ObservableProperty]`.

**Otras propiedades:**
- `_aiParameters`: Modelo `AIParameters` subyacente.
- `SystemPrompt`: Indica el prompt del sistema que sirve como instrucción inicial para la IA.
- `Temperature`: Controla la aleatoriedad de las respuestas de la IA.
- `TopP`: Controla la probabilidad acumulada para el muestreo de tokens.
- `MaxOutputTokens`: Número máximo de tokens permitidos en la respuesta de salida.
- `MaxConversationLength`: Longitud máxima de una conversación en número de mensajes.

**Eventos:**
- Al heredar de `ObservableObject`, notifica cambios en algunas propiedades públicas modificadas explícitamente.

**Métodos públicos:**
- `AIParameters GetRecord()`: Devuelve el registro subyacente de parámetros de IA.
- `void SetRecord(AIParameters parameters)`: Actualiza el ViewModel con un nuevo registro de parámetros de IA.
- `override bool Equals(object? obj)`: Determina si el objeto especificado es igual a la instancia actual.
- `override int GetHashCode()`: Devuelve el código hash de la instancia actual.
- `static bool operator ==(AIParametersViewModel? left, AIParametersViewModel? right)`: Determina si dos instancias son iguales (sobrecarga del operador de igualdad).
- `static bool operator !=(AIParametersViewModel? left, AIParametersViewModel? right)`: Determina si dos instancias no son iguales (sobrecarga del operador de desigualdad).
- `AIParametersViewModel Copy()`: Crea una copia superficial de la instancia actual duplicando el modelo subyacente.

**Notas adicionales:**
- La clase implementa operadores de igualdad y desigualdad para facilitar la comparación entre instancias teniendo en cuenta los valores del modelo subyacente.
- Posee un constructor específico para deserialización decorado con `[JsonConstructor]`.

### 10.1.3 Gestión de agentes