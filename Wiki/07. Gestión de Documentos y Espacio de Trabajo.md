Este apartado se centra en presentar las principales implementaciones que hacen posible la organización y manipulación de documentos dentro de PowerPad. En concreto, se describen los servicios de gestión de documento, del espacio de trabajo y de ordenación de archivos, explicando su función y su papel dentro del sistema. El objetivo es mostrar de forma concisa cómo se ha resuelto técnicamente la gestión de documentos y el espacio de trabajo en la aplicación, facilitando así la comprensión de la estructura interna y la lógica que soporta estas operaciones.

## 7.1. Convenciones
**Descripción general:**
La clase estática `Conventions` proporciona constantes y métodos utilitarios para manejar convenciones comunes para la gestión del espacio de trabajo, como extensiones de archivos y nombres de carpetas especiales.

**Código simplificado:**
```csharp
public static class Conventions
{
    public const string AUTO_SAVE_EXTENSION = ".autosave";
    public const string TRASH_FOLDER_NAME = ".trash";
    public const string ORDER_FILE_NAME = ".order";
    
    public static string AutosavePath(string path) { ... }
}
```

**Constantes:**

- `AUTO_SAVE_EXTENSION`: Extensión de archivo utilizada para archivos guardados automáticamente (".autosave").
- `TRASH_FOLDER_NAME`: Nombre de la carpeta utilizada para almacenar archivos eliminados (".trash").
- `ORDER_FILE_NAME`: Nombre del archivo utilizado para almacenar información de orden (".order").

**Métodos públicos:**

- `AutosavePath(string path)`: Genera la ruta de archivo de auto-guardado agregando la extensión correspondiente al path base proporcionado.

## 7.2. Implementaciones

#### WorkspaceService
**Descripción general:**
La clase `WorkspaceService` implementa la interfaz `IWorkspaceService` y se encarga de gestionar las operaciones principales sobre un espacio de trabajo, como mover, crear, eliminar, renombrar y organizar carpetas y documentos. Utiliza un servicio de orden (`IOrderService`) para mantener el orden de los elementos y gestiona una carpeta de papelera para los elementos eliminados.

**Código simplificado:**
```csharp
public class WorkspaceService : IWorkspaceService
{
    private Folder _root;
    private string _trashFolder;
    private readonly IOrderService _orderService;

    public Folder Root => _root;

    public WorkspaceService(string rootFolder, IOrderService orderService) { ... }

    public void MoveDocument(Document document, Folder targetFolder, int targetPosition) { ... }
    public void MoveFolder(Folder folder, Folder targetFolder, int targetPosition) { ... }
    public void SetPosition(Document document, int targetPosition) { ... }
    public void SetPosition(Folder folder, int targetPosition) { ... }
    public void CreateDocument(Folder parent, Document newDocument, string? content = null) { ... }
    public void CreateFolder(Folder parent, Folder newFolder) { ... }
    public void DeleteDocument(Document document) { ... }
    public void DeleteFolder(Folder folder) { ... }
    public void RenameDocument(Document document, string newName) { ... }
    public void RenameFolder(Folder folder, string newName) { ... }
    public void OpenWorkspace(string rootFolder) { ... }

    private Root InitializeRootFolder(string rootFolder) { ... }
    private Collection<Folder> GetFoldersRecursive(string path) { ... }
    private static Collection<Document> GetDocuments(string path) { ... }
    private static string GetAvailableNewPath(Folder parent, Document child, string? newName = null) { ... }
    private static string GetAvailableNewPath(Folder parent, Folder child, string? newName = null) { ... }
}
```

**Propiedades principales:**

- `Root`: Carpeta raíz del espacio de trabajo gestionado por el servicio.

**Métodos públicos:**

- `MoveDocument(Document document, Folder targetFolder, int targetPosition)`: Mueve un documento a otra carpeta y posición.
- `MoveFolder(Folder folder, Folder targetFolder, int targetPosition)`: Mueve una carpeta a otra carpeta y posición.
- `SetPosition(Document document, int targetPosition)`: Cambia la posición de un documento dentro de su carpeta.
- `SetPosition(Folder folder, int targetPosition)`: Cambia la posición de una carpeta dentro de su carpeta padre.
- `CreateDocument(Folder parent, Document newDocument, string? content = null)`: Crea un nuevo documento en una carpeta.
- `CreateFolder(Folder parent, Folder newFolder)`: Crea una nueva carpeta dentro de otra carpeta.
- `DeleteDocument(Document document)`: Elimina un documento, moviéndolo a la papelera.
- `DeleteFolder(Folder folder)`: Elimina una carpeta, moviéndola a la papelera.
- `RenameDocument(Document document, string newName)`: Renombra un documento.
- `RenameFolder(Folder folder, string newName)`: Renombra una carpeta.
- `OpenWorkspace(string rootFolder)`: Abre un espacio de trabajo en la ruta especificada.

**Otros métodos relevantes:**

- `InitializeRootFolder(string rootFolder)`: Inicializa la carpeta raíz y carga su contenido recursivamente.
- `GetFoldersRecursive(string path)`: Obtiene todas las subcarpetas de una ruta de forma recursiva.
- `GetDocuments(string path)`: Obtiene todos los documentos de una ruta.
- `GetAvailableNewPath(Folder parent, Document child, string? newName = null)`: Obtiene una ruta disponible para un documento, evitando conflictos de nombres.
- `GetAvailableNewPath(Folder parent, Folder child, string? newName = null)`: Obtiene una ruta disponible para una carpeta, evitando conflictos de nombres.

**Notas adicionales:**

- El servicio utiliza una carpeta especial de papelera para almacenar los elementos eliminados, evitando su eliminación permanente inmediata.
- El servicio depende de `IOrderService` para mantener el orden de carpetas y documentos tras cada operación.

#### OrderService
**Descripción general:**
La clase `OrderService` implementa la interfaz `IOrderService` y se encarga de gestionar el orden de las entradas (carpetas y documentos) dentro de carpetas, permitiendo cargar, actualizar y guardar el orden de los elementos cuando se crean, eliminan, renombran o mueven. Utiliza serialización JSON para persistir el orden en archivos asociados a cada carpeta.

**Código simplificado:**
```csharp
public class OrderService : IOrderService
{
    private readonly JsonSerializerContext;

    public void LoadOrderRecursive(Folder root) { ... }
    public void UpdateOrderAfterCreation(Folder parentFolder, string newEntryName) { ... }
    public void UpdateOrderAfterDeletion(Folder parentFolder, string deletedEntryName) { ... }
    public void UpdateOrderAfterRename(Folder parentFolder, string entryOldName, string entryNewName) { ... }
    public void UpdateOrderAfterMove(Folder sourceFolder, Folder? targetFolder, string movedEntryName, int newPosition) { ... }

    private List<string> LoadOrder(Folder parentFolder) { ... }
    private void SaveOrder(Folder parentFolder, List<string> order) { ... }
}
```

**Propiedades principales:**

- `_context`: Contexto de serialización JSON utilizado para leer y escribir el orden de las entradas.

**Métodos públicos:**

- `LoadOrderRecursive(Folder root)`: Carga recursivamente el orden de las entradas en la carpeta raíz y todas sus subcarpetas.
- `UpdateOrderAfterCreation(Folder parentFolder, string newEntryName)`: Actualiza el orden tras la creación de una nueva entrada, añadiéndola al final.
- `UpdateOrderAfterDeletion(Folder parentFolder, string deletedEntryName)`: Actualiza el orden tras la eliminación de una entrada, quitándola de la lista.
- `UpdateOrderAfterRename(Folder parentFolder, string entryOldName, string entryNewName)`: Actualiza el orden tras renombrar una entrada, reemplazando el nombre antiguo por el nuevo.
- `UpdateOrderAfterMove(Folder sourceFolder, Folder? targetFolder, string movedEntryName, int newPosition)`: Actualiza el orden tras mover una entrada entre carpetas o dentro de la misma, ajustando su posición.

**Otros métodos relevantes:**

- `LoadOrder(Folder parentFolder)`: Carga el orden de las entradas de una carpeta desde archivo, inicializándolo si no existe, y sincroniza con los elementos actuales.
- `SaveOrder(Folder parentFolder, List<string> order)`: Guarda el orden de las entradas de una carpeta en un archivo y actualiza la propiedad correspondiente.

**Notas adicionales:**

- Se utiliza el nombre del archivo `ORDER_FILE_NAME` definido en la clase `Conventions`.

#### DocumentService
**Descripción general:**
Implementación de la interfaz `IDocumentService` para gestionar operaciones relacionadas con documentos, como cargar, guardar y autoguardar documentos en el sistema de archivos. Utiliza un contrato de editor para manipular el contenido del documento y actualiza el estado del documento según la operación realizada.

**Código simplificado:**
```csharp
public class DocumentService : IDocumentService
{
    public void LoadDocument(Document document, IEditorContract editor) { ... }
    public async Task AutosaveDocument(Document document, IEditorContract editor) { ... }
    public async Task SaveDocument(Document document, IEditorContract editor) { ... }
}
```

**Métodos públicos:**

- `void LoadDocument(Document document, IEditorContract editor)`: Carga el contenido del documento en el editor, priorizando la versión autoguardada si existe, y actualiza el estado del documento.
- `Task AutosaveDocument(Document document, IEditorContract editor)`: Guarda de forma asíncrona el contenido actual del editor en la ruta de autoguardado y actualiza el estado del documento a autoguardado.
- `Task SaveDocument(Document document, IEditorContract editor)`: Guarda de forma asíncrona el contenido actual del editor en la ruta principal del documento, actualiza el estado a guardado y elimina el archivo de autoguardado si existe.
