En este capítulo se describen en detalle algunos de los elementos fundamentales que articulan el núcleo de PowerPad, la definición de los modelos y contratos (interfaces) principales, así como las algunos enumerados. Estos elementos constituyen la base sobre la que se construyen los servicios y la lógica de negocio del núcleo.

## 6.1. Definición de modelos

### 6.1.1. Servicios de IA

#### AIModel
**Descripción general:**
La clase `AIModel` representa un modelo de inteligencia artificial junto con sus metadatos relevantes, como el proveedor, nombre, URL informativa, tamaño y nombre para mostrar. Es fundamental para identificar y gestionar los modelos AI disponibles en la aplicación.

**Código simplificado:**

```csharp
public record AIModel
{
    public string Name { get; init; } = Name;
    public ModelProvider ModelProvider { get; init; } = ModelProvider;
    public string? InfoUrl { get; init; } = InfoUrl;
    public long? Size { get; set; } = Size;
    public string? DisplayName { get; set; } = DisplayName;
}
```

**Propiedades principales:**
-   `Name`: Nombre del modelo.
-   `ModelProvider`: Proveedor del modelo (Ollama, Hugging Face, etc.).
-   `InfoUrl`: URL opcional con información adicional.
-   `Size`: Tamaño opcional en bytes.
-   `DisplayName`: Nombre para mostrar opcional.

Posee un constructor principal que incluye todos las propiedades, siendo obligatorias `Name` y `ModelProvider`.

#### AIParameters
**Descripción general:**
`AIParameters` define los parámetros configurables que afectan el comportamiento de los modelos AI en el sistema, como el prompt del sistema, la aleatoriedad (temperature), el tamaño del muestreo (top-p), el límite de tokens y la longitud máxima de conversación. Implementa la interfaz `IChatOptions`.

**Código simplificado:**

```csharp
public record AIParameters : IChatOptions
{
    public string? SystemPrompt { get; set; }
    public float? Temperature { get; set; }
    public float? TopP { get; set; }
    public int? MaxOutputTokens { get; set; }
    public int? MaxConversationLength { get; set; }
}
```

**Propiedades principales:**
-   `SystemPrompt`: Instrucción inicial para la IA.
-   `Temperature`: Controla la aleatoriedad de las respuestas.
-   `TopP`: Controla el tamaño del muestreo de tokens.
-   `MaxOutputTokens`: Máximo de tokens permitidos en la respuesta.
-   `MaxConversationLength`: Longitud máxima de la conversación en número de mensajes que se enviará al modelo.

#### Agent
**Descripción general:** 
La clase `Agent` representa un agente de IA con parámetros y configuraciones específicas, incluyendo nombre, prompt, modelo AI asociado y parámetros de comportamiento. Hereda de `AgentParameters` e implementa la interfaz `IChatOptions` indirectamente.

**Código simplificado:**
```csharp
public record Agent() : AgentParameters
{
    public required string Name { get; set; }
    public required string Prompt { get; set; }
    public string? PromptParameterName { get; set; }
    public string? PromptParameterDescription { get; set; }
    public AIModel? AIModel { get; set; }

    internal IChatOptions GetParameters(AIParameters? defaultParameters)
    {
        return new AgentParameters
        {
            Temperature = Temperature ?? defaultParameters?.Temperature,
            TopP = TopP ?? defaultParameters?.TopP,
            MaxOutputTokens = MaxOutputTokens ?? defaultParameters?.MaxOutputTokens
        };
    }
}

public record AgentParameters : IChatOptions
{
    public float? Temperature { get; set; }
    public float? TopP { get; set; }
    public int? MaxOutputTokens { get; set; }
}
```

**Propiedades principales:**
-   `Name`: Nombre del agente.
-   `Prompt`: Prompt utilizado por el agente.
-   `PromptParameterName` y `PromptParameterDescription`: Parámetro y descripción opcional para el prompt.
-   `AIModel`: Modelo AI asociado.
-   `Temperature`: Controla la aleatoriedad de las respuestas (heredada).
-   `TopP`: Controla el tamaño del muestreo de tokens (heredada).
-   `MaxOutputTokens`: Máximo de tokens permitidos en la respuesta (heredada).

**Método relevante:**
-   `GetParameters(AIParameters? defaultParameters)`: Devuelve los parámetros de chat del agente, usando valores por defecto si no están definidos.

#### AIServiceConfig
**Descripción general:**
`AIServiceConfig` encapsula la configuración necesaria para conectar y autenticar servicios de IA externos, como la URL base y la clave API.

**Código simplificado:**
```csharp
public record AIServiceConfig
{
    public string? BaseUrl { get; set; }
    public string? Key { get; set; }
}
```

**Propiedades principales:**
-   `BaseUrl`: URL base del servicio AI.
-   `Key`: Clave API para el acceso al servicio.

#### TestConnectionResult
**Descripción general:**  
Representa el resultado de probar la conexión con el servicio de IA, incluyendo el estado de la conexión y un mensaje de error opcional si la prueba falla.

**Código simplificado:**
```csharp
public readonly record struct TestConnectionResult
{
    ServiceStatus Status { get; init; }
    string? ErrorMessage { get; init; }
}
```

**Propiedades principales:**
- `Status`: Estado de la conexión con el servicio.
- `ErrorMessage`: Mensaje de error opcional si la prueba de conexión falla.

### 6.1.2. Gestión del espacio de trabajo

#### Document
**Descripción general:**
La clase `Document` representa un documento individual dentro del sistema de archivos virtual de PowerPad. Incluye información sobre el contenido, metadatos, estado de edición y referencias a su ubicación dentro de la estructura de carpetas.

**Código simplificado:**
```csharp
public class Document : IFolderEntry
{
    public string Name { get; set; } = name;
    public string Extension { get; set; } = extension;
    public EntryType Type => EntryType.Document;
    public DocumentStatus? Status { get; set; } = DocumentStatus.Unloaded;
    public Folder? Parent { get; internal set; }
    public string Path => $"{Parent?.Path}\\{Name}{Extension}";
    public string AutosavePath => $"{path}{AUTO_SAVE_EXTENSION}";
    public int? Position => Parent?.PositionOf($"{Name}{Extension}");
}
```

**Propiedades principales:**
- `Name`: Nombre del documento.
- `Extension`: Extensión del archivo del documento.
- `Type`: Tipo de entrada, indica que es un documento.
- `Status`: Estado actual del documento (por ejemplo, cargado o no cargado).
- `Parent`: Carpeta padre a la que pertenece el documento.
- `Path`: Ruta completa del documento dentro del sistema de archivos.
- `AutosavePath`: Ruta de guardado automático del documento.
- `Position`: Posición del documento dentro de la carpeta padre.

#### Folder
**Descripción general:**
La clase `Folder` representa una carpeta en el sistema de archivos, la cual puede contener otras carpetas y documentos. Permite gestionar la jerarquía, el acceso y el orden de sus elementos internos.

**Código simplificado:**
```csharp
public class Folder(string name) : IFolderEntry
{
    private readonly Collection<Folder> _folders = [];
    private readonly Collection<Document> _documents = [];
    public string Name { get; set; } = name;
    public EntryType Type => EntryType.Folder;
    public DocumentStatus? Status => null;
    public Folder? Parent { get; internal set; }
    public virtual string Path => $"{Parent?.Path}\\{Name}";
    public ReadOnlyCollection<Folder>? Folders => _folders?.AsReadOnly();
    public ReadOnlyCollection<Document>? Documents => _documents?.AsReadOnly();
    public int? Position => Parent?.PositionOf(Name);
    public List<string>? Order { get; set; }
    internal void AddFolder(Folder folder) { ... }
    internal void AddDocument(Document document) { ... }
    internal void RemoveFolder(Folder folder) { ... }
    internal void RemoveDocument(Document document) { ... }
    internal void AddFolders(IEnumerable<Folder> folders) { ... }
    internal void AddDocuments(IEnumerable<Document> documents) { ... }
    public int? PositionOf(string entryName) { ... }
}
```

**Propiedades principales:**
- `Name`: Nombre de la carpeta.
- `Type`: Tipo de entrada, siempre `EntryType.Folder`.
- `Status`: Estado del documento (siempre `null` para carpetas).
- `Parent`: Carpeta padre de la carpeta actual.
- `Path`: Ruta completa de la carpeta.
- `Folders`: Colección de subcarpetas contenidas en la carpeta.
- `Documents`: Colección de documentos contenidos en la carpeta.
- `Position`: Posición de la carpeta dentro de su carpeta padre.
- `Order`: Lista que define el orden de los elementos dentro de la carpeta.

**Métodos públicos:**
- `int? PositionOf(string entryName)`: Obtiene la posición de una entrada por su nombre dentro de la carpeta.

**Métodos internos relevantes:**
- `void AddFolder(Folder folder)`: Agrega una subcarpeta.
- `void AddDocument(Document document)`: Agrega un documento.
- `void RemoveFolder(Folder folder)`: Elimina una subcarpeta.
- `void RemoveDocument(Document document)`: Elimina un documento.
- `void AddFolders(IEnumerable<Folder> folders)`: Agrega múltiples subcarpetas.
- `void AddDocuments(IEnumerable<Document> documents)`: Agrega múltiples documentos.

#### Root
**Descripción general:**
Representa la carpeta raíz en el sistema de archivos. La carpeta raíz tiene una ruta fija y no posee una carpeta padre.

**Código simplificado:**
```csharp
public class Root(string path) : Folder(string.Empty)
{
    private readonly string _rootPath = path;
    public override string Path => _rootPath;
}
```

**Propiedades principales:**
- `Path`: Obtiene la ruta de la carpeta raíz.

### 6.1.3. Gestión de la configuración

#### ConfigEntry
**Descripción general:**  
Representa una entrada de configuración que almacena su valor serializado y su estado (modificado o no).

**Código simplificado:**
```csharp
internal record ConfigEntry
{
    private string? _serializedValue;
    
    public object? Value { get; private set; }
    public bool Dirty { get; set; }

    public ConfigEntry(string serializedValue, bool dirty) { ... }
    public ConfigEntry(object? value, bool dirty) { ... }
    public T? GetValue<T>(JsonSerializerContext context) { ... }
}
```

**Propiedades principales:**
- `_serializedValue`: Valor serializado de la entrada de configuración.
- `Value`: Obtiene el valor deserializado de la entrada de configuración.
- `Dirty`: Indica si la entrada de configuración ha sido modificada.

**Métodos públicos:**
- `ConfigEntry(string serializedValue, bool dirty)`
- `ConfigEntry(object? value, bool dirty)`
- `T? GetValue<T>(JsonSerializerContext context)`

## 6.2. Contratos e interfaces principales

### 6.2.1 Servicios de IA
#### IAIService
**Descripción general:**  
La interfaz `IAIService` define el contrato que deben implementar los servicios de inteligencia artificial en PowerPad, permitiendo la integración de diferentes proveedores y modelos de IA. Incluye métodos para obtener modelos, obtener el cliente de chat y gestionar la configuración del servicio.

**Código simplificado:**
```csharp
public interface IAIService
{
    void Initialize(AIServiceConfig? config);
    Task<TestConnectionResult> TestConnection();
    IChatClient ChatClient(AIModel model, out IEnumerable<string>? notAllowedParameters);
    Task<IEnumerable<AIModel>> SearchModels(ModelProvider modelProvider, string? query);
}
```

**Métodos públicos:**
- `void Initialize(AIServiceConfig? config)`: Inicializa el servicio de IA con la configuración especificada.
- `Task<TestConnectionResult> TestConnection()`: Prueba la conexión con el servicio de IA.
- `IChatClient ChatClient(AIModel model, out IEnumerable<string>? notAllowedParameters)`: Crea un cliente de chat para el modelo de IA especificado, indicando los parámetros no permitidos.
- `Task<IEnumerable<AIModel>> SearchModels(ModelProvider modelProvider, string? query)`: Busca modelos de IA según el proveedor y una consulta opcional.

#### IOllamaService
**Descripción general:**  
Define el contrato para la gestión de servicios de Ollama, incluyendo la administración de modelos y operaciones del ciclo de vida del servicio.

**Código simplificado:**
```csharp
public interface IOllamaService
{
    Task Start();
    Task Stop();
    Task<IEnumerable<AIModel>> GetInstalledModels();
    Task DownloadModel(AIModel model, Action<double> updateAction, Action errorAction, CancellationToken cancellationToken);
    Task DeleteModel(AIModel model);
}
```

**Métodos públicos:**
- `Task Start()`: Inicia el servicio Ollama.
- `Task Stop()`: Detiene el servicio Ollama.
- `Task<IEnumerable<AIModel>> GetInstalledModels()`: Recupera la lista de modelos de IA instalados.
- `Task DownloadModel(AIModel model, Action<double> updateAction, Action errorAction, CancellationToken cancellationToken)`: Descarga un modelo de IA con actualizaciones de progreso y manejo de errores.
- `Task DeleteModel(AIModel model)`: Elimina un modelo de IA instalado.

#### IChatService
**Descripción general:**
Interfaz que define el contrato para un servicio de chat que interactúa con modelos y agentes de IA, proporcionando métodos para configurar modelos y parámetros por defecto, y para obtener respuestas de chat y agentes de forma asincrónica.

**Código simplificado:**
```csharp
public interface IChatService
{
    void SetDefaultModel(AIModel? defaultModel);
    void SetDefaultParameters(AIParameters? defaultParameters);
    IAsyncEnumerable<ChatResponseUpdate> GetChatResponse(IList<ChatMessage> messages, AIModel? model = null, AIParameters? parameters = null, CancellationToken cancellationToken = default);
    IAsyncEnumerable<ChatResponseUpdate> GetAgentResponse(IList<ChatMessage> messages, Agent agent, CancellationToken cancellationToken = default);
    Task GetAgentSingleResponse(string input, StringBuilder output, Agent agent, string? promptParameterValue, string? agentPrompt, CancellationToken cancellationToken = default);
}
```

**Métodos públicos:**
- `SetDefaultModel(AIModel? defaultModel)`: Establece el modelo de IA predeterminado para el servicio de chat.
- `SetDefaultParameters(AIParameters? defaultParameters)`: Establece los parámetros predeterminados para el servicio de chat.
- `GetChatResponse(IList<ChatMessage> messages, AIModel? model = null, AIParameters? parameters = null, CancellationToken cancellationToken = default)`: Obtiene una respuesta de chat en streaming basada en los mensajes proporcionados y, opcionalmente, el modelo y los parámetros.
- `GetAgentResponse(IList<ChatMessage> messages, Agent agent, CancellationToken cancellationToken = default)`: Obtiene una respuesta en streaming de un agente de IA basada en los mensajes proporcionados.
- `GetAgentSingleResponse(string input, StringBuilder output, Agent agent, string? promptParameterValue, string? agentPrompt, CancellationToken cancellationToken = default)`: Obtiene una única respuesta de un agente de IA basada en la entrada proporcionada y la agrega al output.

#### IChatOptions
**Descripción general:**
La interfaz `IChatOptions` define las opciones de configuración para el comportamiento del chat, permitiendo ajustar parámetros como la aleatoriedad de las respuestas, la probabilidad acumulada para el muestreo de tokens y el número máximo de tokens en la respuesta.

**Código simplificado:**
```csharp
internal interface IChatOptions
{
    float? Temperature { get; set; }
    float? TopP { get; set; }
    int? MaxOutputTokens { get; set; }
}
```

**Propiedades principales:**
-   `Temperature`: Controla la aleatoriedad de las respuestas.
-   `TopP`: Controla el tamaño del muestreo de tokens.
-   `MaxOutputTokens`: Máximo de tokens permitidos en la respuesta.

### 6.2.2 Gestión del espacio de trabajo
#### IWorkspaceService
**Descripción general:**  
Interfaz que proporciona métodos para gestionar y manipular el espacio de trabajo, incluyendo operaciones sobre carpetas y documentos como mover, crear, eliminar, renombrar y establecer su posición.

**Código simplificado:**
```csharp
public interface IWorkspaceService
{
    Folder Root { get; }
    void MoveDocument(Document document, Folder targetFolder, int targetPosition);
    void MoveFolder(Folder folder, Folder targetFolder, int targetPosition);
    void SetPosition(Document document, int targetPosition);
    void SetPosition(Folder folder, int targetPosition);
    void CreateDocument(Folder parent, Document newDocument, string? content = null);
    void CreateFolder(Folder parent, Folder newFolder);
    void DeleteDocument(Document document);
    void DeleteFolder(Folder folder);
    void RenameDocument(Document document, string newName);
    void RenameFolder(Folder folder, string newName);
    void OpenWorkspace(string rootFolder);
}
```

**Propiedades principales:**
- `Root`: Obtiene la carpeta raíz del espacio de trabajo.

**Métodos públicos:**
- `void MoveDocument(Document document, Folder targetFolder, int targetPosition)`
- `void MoveFolder(Folder folder, Folder targetFolder, int targetPosition)`
- `void SetPosition(Document document, int targetPosition)`
- `void SetPosition(Folder folder, int targetPosition)`
- `void CreateDocument(Folder parent, Document newDocument, string? content = null)`
- `void CreateFolder(Folder parent, Folder newFolder)`
- `void DeleteDocument(Document document)`
- `void DeleteFolder(Folder folder)`
- `void RenameDocument(Document document, string newName)`
- `void RenameFolder(Folder folder, string newName)`
- `void OpenWorkspace(string rootFolder)`

#### IOrderService
**Descripción general:**
Interfaz que proporciona métodos para gestionar y actualizar el orden de las entradas (carpetas y documentos) dentro de una carpeta, permitiendo operaciones como carga, creación, eliminación, renombrado y movimiento de entradas.

**Código simplificado:**
```csharp
public interface IOrderService
{
    void LoadOrderRecursive(Folder root);
    void UpdateOrderAfterCreation(Folder parentFolder, string newEntryName);
    void UpdateOrderAfterDeletion(Folder parentFolder, string deletedEntryName);
    void UpdateOrderAfterRename(Folder parentFolder, string entryOldName, string entryNewName);
    void UpdateOrderAfterMove(Folder sourceFolder, Folder? targetFolder, string movedEntryName, int newPosition);
}
```

**Métodos públicos:**
- `void LoadOrderRecursive(Folder root)`: Aplica el orden de las entradas de forma recursiva para la carpeta raíz y sus subcarpetas.
- `void UpdateOrderAfterCreation(Folder parentFolder, string newEntryName)`: Actualiza el orden tras la creación de una nueva entrada en la carpeta especificada.
- `void UpdateOrderAfterDeletion(Folder parentFolder, string deletedEntryName)`: Actualiza el orden tras la eliminación de una entrada en la carpeta especificada.
- `void UpdateOrderAfterRename(Folder parentFolder, string entryOldName, string entryNewName)`: Actualiza el orden tras el renombrado de una entrada en la carpeta especificada.
- `void UpdateOrderAfterMove(Folder sourceFolder, Folder? targetFolder, string movedEntryName, int newPosition)`: Actualiza el orden tras mover una entrada entre carpetas o dentro de la misma carpeta.

#### IDocumentService
**Descripción general:**  
Interfaz que proporciona métodos para gestionar y manipular documentos en el sistema de archivos, incluyendo la carga, guardado y autoguardado de documentos en editores.

**Código simplificado:**
```csharp
public interface IDocumentService
{
    void LoadDocument(Document document, IEditorContract editor);
    Task AutosaveDocument(Document document, IEditorContract editor);
    Task SaveDocument(Document document, IEditorContract editor);
}
```

**Métodos públicos:**
- `void LoadDocument(Document document, IEditorContract editor)`: Carga el contenido de un documento en el editor.
- `Task AutosaveDocument(Document document, IEditorContract editor)`: Realiza el autoguardado del documento en su ruta de autoguardado.
- `Task SaveDocument(Document document, IEditorContract editor)`: Guarda el documento en su ruta principal y elimina cualquier archivo de autoguardado.

#### IFolderEntry
**Descripción general:**  
La interfaz `IFolderEntry` representa una entrada dentro de una carpeta del sistema de archivos virtual, permitiendo la abstracción de documentos y carpetas.

**Código simplificado:**
```csharp
public interface IFolderEntry
{
    string Name { get; }
    string Path { get; }
    EntryType Type { get; }
    DocumentStatus? Status { get; }
    Folder? Parent { get; }
    int? Position { get; }
}
```

**Propiedades principales:**
- `Name`: Obtiene el nombre de la carpeta o documento.
- `Path`: Obtiene la ruta completa de la carpeta o documento.
- `Type`: Obtiene el tipo de la entrada (por ejemplo, Carpeta o Documento).
- `Status`: Obtiene el estado actual del documento, si aplica.
- `Parent`: Obtiene la carpeta padre de la entrada, si existe.
- `Position`: Obtiene la posición de la entrada dentro de su carpeta padre, si aplica.

#### IEditorContract
**Descripción general:**
La interfaz `IEditorContract` define el contrato que debe cumplir cualquier editor de documentos en PowerPad, permitiendo operaciones de carga, guardado y manipulación del contenido.

**Código simplificado:**
```csharp
public interface IEditorContract
{
    string GetContent(bool plainText = false);
    void SetContent(string content);
    int WordCount();
}
```

**Métodos públicos:**
- `string GetContent(bool plainText = false)`: Recupera el contenido del editor, opcionalmente como texto plano.
- `void SetContent(string content)`: Establece el contenido del editor.
- `int WordCount()`: Calcula el número de palabras en el contenido del editor.

### 6.2.3 Gestión de la configuración
#### IConfigStore
**Descripción general:**
Interfaz que define métodos para almacenar y recuperar valores de configuración mediante claves enumeradas.

**Código simplificado:**
```csharp
public interface IConfigStore
{
    void Set<T>(Enum key, T config);
    T Get<T>(Enum key);
    T? TryGet<T>(Enum key);
}
```

**Métodos públicos:**
- `void Set<T>(Enum key, T config)`: Establece un valor de configuración para la clave especificada.
- `T Get<T>(Enum key)`: Recupera un valor de configuración para la clave especificada.
- `T? TryGet<T>(Enum key)`: Intenta recuperar un valor de configuración para la clave especificada; devuelve el valor si existe, de lo contrario, devuelve `null`.

#### IConfigStoreService
**Descripción general:**
Interfaz que proporciona métodos para gestionar almacenes de configuración y guardar configuraciones.

**Código simplificado:**
```csharp
public interface IConfigStoreService
{
    IConfigStore GetConfigStore(string configFolder);
    Task StoreConfigs();
}
```

**Métodos públicos:**
- `IConfigStore GetConfigStore(string configFolder)`: Recupera o crea un almacén de configuración para la carpeta especificada.
- `Task StoreConfigs()`: Guarda todas las configuraciones en sus respectivos archivos de manera asíncrona.

## 6.3. Enumeraciones

#### ModelProvider
**Descripción general:**  
La enumeración `ModelProvider` define los proveedores de modelos de inteligencia artificial soportados por PowerPad.  

**Código simplificado:**
```csharp
public enum ModelProvider
{
    Ollama,
    HuggingFace,
    GitHub,
    OpenAI
}
```

#### ServiceStatus
**Descripción general:**  
La enumeración `ServiceStatus` que representa los posibles estados de un servicio de inteligencia artificial.  

**Código simplificado:**
```csharp
public enum ServiceStatus
{
    Unknown,
    Unconfigured,
    Updating,
    Available,
    Online,
    Error,
    NotFound
}
```
#### EntryType
**Descripción general:**  
La enumeración `EntryType` especifica el tipo de entrada en el sistema de archivos virtual, pudiendo ser una carpeta o un documento.

**Código simplificado:**
```csharp
public enum EntryType
{
    Folder,
    Document
}
```